<!DOCTYPE html>
<html lang="th">
<head>
 <meta charset="UTF-8">
    <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ</title>

    <script>
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤ isLoggedIn ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "true" ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (sessionStorage.getItem("isLoggedIn") !== "true") {
            window.location.href = "index.html"; 
        }
    </script>
    
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì... */
    </style>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CCTV ONLINE SYSTEM - FIREBASE</title>
 
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
 
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
 
<style>
body { margin:0; background:#0f172a; color:white; font-family:system-ui; overflow:hidden; }
.topbar { height:60px; background:linear-gradient(90deg,#0b2447,#19376d); display:flex; align-items:center; justify-content:space-between; padding:0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 10001; position: relative; }
.grid-btn { background:#2563eb; border:none; color:white; padding:6px 14px; border-radius:6px; cursor:pointer; font-weight: bold; transition: 0.2s; }
.admin-btns { display: none; gap: 10px; }
.btn-add { background: #10b981; }
.btn-logout { background: #ef4444; }

.modal { display:none; position:fixed; z-index:20000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; }
.modal-content { background:#1e293b; padding:25px; border-radius:12px; width:350px; border:1px solid #334155; }
.modal-content input { width:100%; padding:10px; margin:10px 0; background:#0f172a; border:1px solid #334155; color:white; border-radius:6px; box-sizing:border-box; }

.main-container { display:flex; height:calc(100vh - 60px); }
.sidebar { width:320px; background:#1e293b; display:flex; flex-direction:column; border-right: 1px solid #334155; }
.status-summary { padding: 20px 15px; background: #111827; border-bottom: 1px solid #334155; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.stat-box { text-align: center; font-size: 9px; color: #94a3b8; }
.stat-box b { font-size: 16px; color: white; display: block; }
 
.camera-item { background:#111827; padding:8px 12px; border-radius:8px; margin-bottom:6px; cursor:pointer; border-left:4px solid transparent; transition:0.2s; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
.camera-item b { font-weight: 500; }
.camera-item small { font-size: 10px; }
 
.camera-item.active-play { 
    border-left: 4px solid #3b82f6; 
    background: #1e293b; 
    animation: pulse-blue 1.0s infinite ease-in-out; 
}
@keyframes pulse-blue { 
    0% { box-shadow: inset 0 0 0px rgba(37, 99, 235, 0); } 
    50% { box-shadow: inset 0 0 15px rgba(37, 99, 235, 0.5); } 
    100% { box-shadow: inset 0 0 0px rgba(37, 99, 235, 0); } 
}
 
#map { flex:1; z-index:1; }

/* Grid View CSS Updates */
.grid-overlay { position:fixed; top:60px; left:0; right:0; bottom:0; background:#020617; display:none; padding:15px; z-index:10000; overflow-y: auto; }
.grid-full { display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; width: 100%; align-content: start; }
.grid-item { 
    position:relative; 
    background:#000; 
    border-radius: 6px; 
    overflow: hidden; 
    border: 1px solid #334155; 
    aspect-ratio: 16/9; 
    display: flex;       /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
    align-items: center; 
    justify-content: center;
}
.grid-item video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ã‡∏π‡∏° ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö */
    cursor: pointer;
}

.leaflet-tooltip { background: #000 !important; border: 2px solid #3b82f6 !important; padding: 0 !important; border-radius: 8px !important; overflow: hidden; opacity: 1 !important; pointer-events: auto !important; }
.video-box { width: 350px; aspect-ratio: 16/9; position: relative; background: #000; }
.video-box video { width: 100%; height: 100%; object-fit: contain; display: block; cursor: pointer; }
</style>
</head>
<body>
 
<div class="topbar">
    <div>
        <span onclick="openLogin()" style="cursor:pointer">üì° <b>CCTV ONLINE</b></span>
        <button class="grid-btn" style="margin-left:15px" onclick="toggleGrid()">GRID VIEW</button>
    </div>
    <div class="admin-btns" id="adminControls">
        <button class="grid-btn btn-add" onclick="openCamModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        <button class="grid-btn btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>
 
<div class="main-container">
    <div class="sidebar">
        <div class="status-summary">
            <div class="stat-box"><span>TOTAL</span><b id="stat-total">0</b></div>
            <div class="stat-box"><span>ONLINE</span><b id="stat-online" style="color:#22c55e">0</b></div>
            <div class="stat-box"><span>OFFLINE</span><b id="stat-offline" style="color:#ef4444">0</b></div>
        </div>
        <div class="camera-list-container" style="overflow-y:auto; flex:1; padding:10px;">
            <h4 style="margin:0 0 10px 0; color:#94a3b8; font-size:10px; letter-spacing: 1px;">üì∑ ONLINE DEVICE</h4>
            <div id="cameraList"></div>
        </div>
    </div>
    <div id="map"></div>
</div>
 
<div class="grid-overlay" id="gridOverlay"><div class="grid-full" id="gridFull"></div></div>
 
<div class="modal" id="loginModal">
    <div class="modal-content">
        <h3>üîí Admin Login</h3>
        <input type="password" id="passInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô..." onkeyup="checkEnter(event)">
        <button class="grid-btn" style="width:100%" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button class="grid-btn" style="width:100%; background:transparent; margin-top:5px" onclick="closeModal('loginModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>
 
<div class="modal" id="camModal">
    <div class="modal-content">
        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πâ‡∏≠‡∏á</h3>
        <input type="hidden" id="editIdx">
        <input type="text" id="camName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á">
        <input type="number" id="camLat" step="any" placeholder="Lat">
        <input type="number" id="camLng" step="any" placeholder="Lng">
        <input type="text" id="camURL" placeholder="URL .m3u8">
        <button class="grid-btn btn-add" style="width:100%; margin-top:10px" onclick="saveCamera()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button id="delBtn" class="grid-btn btn-logout" style="width:100%; margin-top:5px; display:none" onclick="deleteCamera()">‡∏•‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
        <button class="grid-btn" style="width:100%; background:transparent; margin-top:5px" onclick="closeModal('camModal')">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>
 
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBAnzM3E8ZL7B7PXhaI1KgUBzBGWESq3Js",
  authDomain: "cctv-276a1.firebaseapp.com",
  databaseURL: "https://cctv-276a1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "cctv-276a1",
  storageBucket: "cctv-276a1.firebasestorage.app",
  messagingSenderId: "771343203688",
  appId: "1:771343203688:web:6dbbf5131e7b7d42c9aadd",
  measurementId: "G-9894M76PV4"
};
 
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
 
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Login ---
function checkEnter(event) {
    if (event.key === "Enter") {
        login();
    }
}
 
function toggleFullscreen(v) {
    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
        if (v.requestFullscreen) v.requestFullscreen();
        else if (v.webkitRequestFullscreen) v.webkitRequestFullscreen();
    } else {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    }
}
 
var googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20 });
var googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 20 });
var googleStreets = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20 });
var map = L.map('map', { center: [17.4138, 102.7876], zoom: 14, layers: [googleHybrid] });
L.control.layers({"‡πÑ‡∏Æ‡∏ö‡∏£‡∏¥‡∏î": googleHybrid, "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°": googleSat, "‡∏ñ‡∏ô‡∏ô":googleStreets}, null, { collapsed: false }).addTo(map);
 
let cameras = [];
let activeHls = {};
let markers = {};
let isAdmin = false;
 
db.ref('cameras').on('value', (snapshot) => {
    const data = snapshot.val();
    cameras = [];
    if (data) {
       Object.keys(data).forEach(key => {
           cameras.push({ id: key, ...data[key] });
        });
    }
    updateUI();
});
 
function updateUI() {
    for(let id in markers) map.removeLayer(markers[id]);
    markers = {};
    document.getElementById("cameraList").innerHTML = "";
    
    cameras.forEach((cam, index) => {
        let isOnline = cam.stream !== "";
        let color = isOnline ? "#22c55e" : "#ef4444";
        let marker = L.marker([cam.lat, cam.lng], { 
            icon: L.divIcon({
               className:"",
               html: `<div style="width:30px;height:30px;border-radius:50%;background:#111;border:2px solid ${color};display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:10px;box-shadow:0 0 10px rgba(0,0,0,0.5);">${index+1}</div>`,
               iconSize:[30,30]
            }) 
        }).addTo(map);
        
        marker.on("click", () => isAdmin ? openCamModal(index) : toggleCamera(cam, index));
        markers[index] = marker;
 
        const div = document.createElement("div");
        div.className = "camera-item";
        div.id = "item-" + index;
        div.innerHTML = `<b>${index+1}. ${cam.name}</b><small style="color:${color}">‚óè ${isOnline ? 'ON' : 'OFF'}</small>`;
        div.onclick = () => isAdmin ? openCamModal(index) : toggleCamera(cam, index);
        document.getElementById("cameraList").appendChild(div);
    });
 
    document.getElementById('stat-total').innerText = cameras.length;
    document.getElementById('stat-online').innerText = cameras.filter(c => c.stream !== "").length;
    document.getElementById('stat-offline').innerText = cameras.filter(c => c.stream === "").length;
}
 
function toggleCamera(cam, idx) {
    if(cam.stream === "") return;
    if (activeHls[idx]) {
       activeHls[idx].destroy(); delete activeHls[idx];
       markers[idx].closeTooltip(); markers[idx].unbindTooltip();
       document.getElementById("item-"+idx).classList.remove("active-play");
    } else {
       markers[idx].bindTooltip(
           `<div class="video-box" id="box-${idx}">
               <video id="v-${idx}" autoplay muted controls ondblclick="toggleFullscreen(this)" onclick="event.stopPropagation();"></video>
           </div>`, 
           { permanent: true, direction: 'top', opacity: 1, interactive: true }
       ).openTooltip();
        
       const box = document.getElementById(`box-${idx}`);
       if(box) {
           L.DomEvent.disableClickPropagation(box);
           L.DomEvent.on(box, 'dblclick', L.DomEvent.stopPropagation);
       }
 
       if (Hls.isSupported()) {
           const hls = new Hls(); hls.loadSource(cam.stream);
           hls.attachMedia(document.getElementById(`v-${idx}`));
           activeHls[idx] = hls;
           document.getElementById("item-"+idx).classList.add("active-play");
       }
    }
}
 
function saveCamera() {
    const idx = document.getElementById("editIdx").value;
    const data = {
        name: document.getElementById("camName").value || "Cam",
        lat: parseFloat(document.getElementById("camLat").value),
        lng: parseFloat(document.getElementById("camLng").value),
        stream: document.getElementById("camURL").value
    };
 
    if(idx !== "") {
        const camId = cameras[idx].id;
        db.ref('cameras/' + camId).set(data);
    } else {
        db.ref('cameras').push(data);
    }
    closeModal("camModal");
}
 
function deleteCamera() {
    const idx = document.getElementById("editIdx").value;
    if(idx !== "" && confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?")) {
        const camId = cameras[idx].id;
        db.ref('cameras/' + camId).remove();
        closeModal("camModal");
    }
}
 
function login() { 
    if(document.getElementById("passInput").value === "admin2") { 
        isAdmin = true; 
        document.getElementById("adminControls").style.display = "flex"; 
        closeModal("loginModal"); 
        document.getElementById("passInput").value = ""; 
    } else {
        alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
}
function openLogin() { if(!isAdmin) { document.getElementById("loginModal").style.display = "flex"; document.getElementById("passInput").focus(); } }
function logout() { isAdmin = false; document.getElementById("adminControls").style.display = "none"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
 
function openCamModal(idx = null) {
    document.getElementById("editIdx").value = idx !== null ? idx : "";
    if(idx !== null) {
        document.getElementById("camName").value = cameras[idx].name;
        document.getElementById("camLat").value = cameras[idx].lat;
        document.getElementById("camLng").value = cameras[idx].lng;
        document.getElementById("camURL").value = cameras[idx].stream;
        document.getElementById("delBtn").style.display = "block";
    } else {
        document.getElementById("camName").value = "";
        document.getElementById("camLat").value = map.getCenter().lat.toFixed(5);
        document.getElementById("camLng").value = map.getCenter().lng.toFixed(5);
        document.getElementById("camURL").value = "";
        document.getElementById("delBtn").style.display = "none";
    }
    document.getElementById("camModal").style.display = "flex";
}
 
function toggleGrid() {
    const o = document.getElementById("gridOverlay");
    o.style.display = o.style.display === "block" ? "none" : "block";
    const g = document.getElementById("gridFull"); g.innerHTML = "";
    if(o.style.display === "block") {
        cameras.forEach((cam, i) => {
            const item = document.createElement("div"); 
            item.className = "grid-item";
            if (cam.stream !== "") {
                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° object-fit:contain ‡πÅ‡∏•‡∏∞ style ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                item.innerHTML = `
                <video autoplay muted id="gv-${i}" 
                       style="width:100%; height:100%; object-fit:contain;" 
                       ondblclick="toggleFullscreen(this)"></video>
                <div style="position:absolute;top:0;left:0;background:rgba(0,0,0,0.7);font-size:10px;padding:4px;z-index:10">#${i+1} ${cam.name}</div>`;
                g.appendChild(item);
                if (Hls.isSupported()) { 
                    const h = new Hls(); 
                    h.loadSource(cam.stream); 
                    h.attachMedia(document.getElementById(`gv-${i}`)); 
                }
            } else { 
                item.innerHTML = `<div style="color:red;padding:20px;font-size:10px;text-align:center;">OFFLINE</div>`; 
                g.appendChild(item); 
            }
        });
    }
}
</script>
</body>
</html>

